# TJ's Bake & Browse - API Schema Documentation

## **Database Schema (ACTUAL IMPLEMENTED SCHEMA)**

### **1. Products Table (CORRECTED SCHEMA)**

```sql
CREATE TABLE public.products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    sku TEXT UNIQUE NOT NULL,
    short_description TEXT,
    full_description TEXT,
    price_pence INTEGER NOT NULL CHECK (price_pence >= 0),
    pack_label TEXT,
    allergens TEXT[] DEFAULT '{}',
    ingredients TEXT,
    nutritional_info JSONB,
    image_url TEXT,
    stock_quantity INTEGER NOT NULL DEFAULT 0,
    low_stock_threshold INTEGER DEFAULT 5,
    is_visible BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    category_id UUID REFERENCES public.categories(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Fields:**

- `id`: Unique identifier
- `name`: Product name
- `sku`: Stock keeping unit (unique)
- `short_description`: Brief product description
- `full_description`: Detailed product description
- `price_pence`: Price in pence (whole number)
- `pack_label`: Package size/weight information
- `allergens`: Array of allergen information
- `ingredients`: List of ingredients
- `nutritional_info`: JSON nutritional data
- `image_url`: Product image URL
- `stock_quantity`: Current stock level
- `low_stock_threshold`: Stock level warning threshold
- `is_visible`: Whether product is visible to customers
- `is_featured`: Whether product is featured
- `category_id`: Foreign key to categories table
- `created_at`: Creation timestamp
- `updated_at`: Last update timestamp

### **2. Categories Table**

```sql
CREATE TABLE public.categories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    slug TEXT UNIQUE NOT NULL,
    description TEXT,
    image_url TEXT,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Fields:**

- `id`: Unique identifier
- `name`: Category name
- `slug`: URL-friendly identifier
- `description`: Category description
- `image_url`: Category image URL
- `sort_order`: Display order
- `is_active`: Whether category is active
- `created_at`: Creation timestamp
- `updated_at`: Last update timestamp

### **3. Orders Table (CORRECTED SCHEMA)**

```sql
CREATE TABLE public.orders (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    order_number BIGINT GENERATED BY DEFAULT AS IDENTITY UNIQUE,
    user_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
    status TEXT NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'confirmed', 'preparing', 'ready', 'collected', 'cancelled')),
    pickup_date DATE NOT NULL,
    pickup_time TIME NOT NULL,
    subtotal_pence INTEGER NOT NULL,
    tax_pence INTEGER NOT NULL DEFAULT 0,
    bag_fee_pence INTEGER NOT NULL DEFAULT 0,
    total_pence INTEGER NOT NULL,
    customer_name TEXT NOT NULL,
    customer_email TEXT NOT NULL,
    customer_phone TEXT,
    special_instructions TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Fields:**

- `id`: Unique identifier
- `order_number`: Auto-generated sequential order number
- `user_id`: Reference to user (optional)
- `status`: Order status (pending, confirmed, preparing, ready, collected, cancelled)
- `pickup_date`: Scheduled pickup date
- `pickup_time`: Scheduled pickup time
- `subtotal_pence`: Subtotal before fees
- `tax_pence`: Tax amount in pence
- `bag_fee_pence`: Bag fee amount
- `total_pence`: Total including all fees
- `customer_name`: Customer's name
- `customer_email`: Customer's email
- `customer_phone`: Customer's phone number
- `special_instructions`: Special order instructions
- `created_at`: Creation timestamp
- `updated_at`: Last update timestamp

### **4. Order Items Table (CORRECTED SCHEMA)**

```sql
CREATE TABLE public.order_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    order_id UUID REFERENCES public.orders(id) ON DELETE CASCADE,
    product_id UUID REFERENCES public.products(id),
    product_name TEXT NOT NULL,
    product_sku TEXT NOT NULL,
    quantity INTEGER NOT NULL,
    unit_price_pence INTEGER NOT NULL,
    total_price_pence INTEGER NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Fields:**

- `id`: Unique identifier
- `order_id`: Reference to parent order
- `product_id`: Reference to product
- `product_name`: Product name at time of order
- `product_sku`: Product SKU at time of order
- `quantity`: Quantity ordered
- `unit_price_pence`: Unit price in pence
- `total_price_pence`: Total price for this item
- `created_at`: Creation timestamp

### **5. Configurable Fees Table (CORRECTED SCHEMA)**

```sql
CREATE TABLE public.configurable_fees (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    fee_type TEXT NOT NULL DEFAULT 'fixed'
        CHECK (fee_type IN ('fixed', 'percentage')),
    amount_pence INTEGER NOT NULL DEFAULT 0,
    percentage_rate DECIMAL(5,2) DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    applies_to TEXT[] DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Fields:**

- `id`: Unique identifier
- `name`: Fee name (e.g., "Bag Fee")
- `description`: Fee description
- `fee_type`: Type of fee (fixed or percentage)
- `amount_pence`: Fixed fee amount in pence
- `percentage_rate`: Percentage rate for percentage fees
- `is_active`: Whether fee is currently active
- `applies_to`: Array of order types this applies to
- `created_at`: Creation timestamp
- `updated_at`: Last update timestamp

### **Indexes for Performance (CORRECTED)**

```sql
CREATE INDEX idx_products_category_id ON public.products(category_id);
CREATE INDEX idx_products_is_visible ON public.products(is_visible);
CREATE INDEX idx_products_stock_quantity ON public.products(stock_quantity);
CREATE INDEX idx_orders_status ON public.orders(status);
CREATE INDEX idx_orders_pickup_date ON public.orders(pickup_date);
CREATE INDEX idx_order_items_order_id ON public.order_items(order_id);
```

## üîí **Row Level Security (RLS)**

### **RLS Policies**

#### **Products Table**

```sql
CREATE POLICY "Public read access" ON public.products FOR SELECT USING (true);
```

- **Purpose**: Allow public read access to visible products
- **Scope**: All users can view products

#### **Categories Table**

```sql
CREATE POLICY "Public read access" ON public.categories FOR SELECT USING (true);
```

- **Purpose**: Allow public read access to categories
- **Scope**: All users can view categories

#### **Orders Table**

```sql
CREATE POLICY "Users can view their own orders" ON public.orders
    FOR SELECT USING (auth.uid()::text = customer_email OR customer_email IS NULL);

CREATE POLICY "Users can create orders" ON public.orders
    FOR INSERT WITH CHECK (true);

CREATE POLICY "Users can update their own orders" ON public.orders
    FOR UPDATE USING (auth.uid()::text = customer_email OR customer_email IS NULL);
```

- **Purpose**: Users can only see and modify their own orders
- **Scope**: Authenticated users see their orders, guests see orders by email

#### **Order Items Table**

```sql
CREATE POLICY "Users can view their order items" ON public.order_items
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM public.orders
            WHERE orders.id = order_items.order_id
            AND (orders.customer_email = auth.uid()::text OR orders.customer_email IS NULL)
        )
    );

CREATE POLICY "Users can create order items" ON public.order_items
    FOR INSERT WITH CHECK (true);
```

- **Purpose**: Users can only see items from their orders
- **Scope**: Linked to order access policies

#### **Configurable Fees Table**

```sql
CREATE POLICY "Public read access" ON public.configurable_fees FOR SELECT USING (true);
```

- **Purpose**: Allow public read access to fee information
- **Scope**: All users can view fees

## üåê **API Endpoints**

### **Products API**

#### **GET /api/products**

- **Purpose**: Retrieve all visible products
- **Response**: List of products with category information
- **Authentication**: Not required
- **RLS**: Public read access

**Response Format:**

```json
{
	"products": [
		{
			"id": "uuid",
			"name": "Product Name",
			"price_pence": 450,
			"image_url": "/images/product.jpg",
			"pack_label": "500g",
			"allergens": ["none"],
			"sku": "PROD-001",
			"stock": 15,
			"visible": true,
			"category_id": "uuid",
			"categories": {
				"id": "uuid",
				"name": "Category Name",
				"slug": "category_slug"
			}
		}
	]
}
```

### **Orders API**

#### **POST /api/orders**

- **Purpose**: Create new order
- **Request Body**: Order details with items
- **Authentication**: Not required (guest orders)
- **RLS**: Public insert access

**Request Format:**

```json
{
	"pickup_date": "2025-08-15",
	"pickup_time": "10:00-12:00",
	"customer_name": "John Doe",
	"customer_email": "john@example.com",
	"bag_opt_in": true,
	"items": [
		{
			"product_id": "uuid",
			"quantity": 2,
			"price_pence": 450
		}
	]
}
```

**Response Format:**

```json
{
	"success": true,
	"order": {
		"id": "uuid",
		"order_number": 1001,
		"status": "pending",
		"total_pence": 950
	}
}
```

#### **GET /api/admin/orders**

- **Purpose**: Retrieve orders for admin
- **Authentication**: Admin required
- **RLS**: Admin access policies

#### **PATCH /api/admin/orders/[id]**

- **Purpose**: Update order status
- **Authentication**: Admin required
- **RLS**: Admin access policies

### **Cart API**

#### **GET /api/cart**

- **Purpose**: Retrieve cart contents
- **Response**: Cart items from localStorage
- **Authentication**: Not required
- **Storage**: Client-side localStorage

#### **POST /api/cart**

- **Purpose**: Add item to cart
- **Request Body**: Product details
- **Authentication**: Not required
- **Storage**: Client-side localStorage

#### **PATCH /api/cart**

- **Purpose**: Update item quantity
- **Request Body**: Product ID and new quantity
- **Authentication**: Not required
- **Storage**: Client-side localStorage

#### **DELETE /api/cart**

- **Purpose**: Remove item from cart
- **Request Body**: Product ID
- **Authentication**: Not required
- **Storage**: Client-side localStorage

### **Time Slots API**

#### **GET /api/slots**

- **Purpose**: Retrieve available pickup time slots
- **Response**: Available time slots
- **Authentication**: Not required
- **RLS**: Public read access

## üîÑ **Data Flow**

### **Product Browsing**

1. User visits `/baked-goods` or `/groceries`
2. Page calls `/api/products` endpoint
3. Supabase returns products filtered by category
4. Products displayed in grid with "Add to Basket" buttons

### **Cart Management**

1. User clicks "Add to Basket"
2. Item added to localStorage via cart API
3. Cart context updates basket count
4. Toast notification shows success message

### **Order Creation**

1. User proceeds to checkout
2. Cart items converted to order items
3. Order created in database
4. Order items linked to order
5. Confirmation sent to user

## üö® **Important Notes**

### **RLS Policy Fixes**

- **Issue**: Previous RLS policies caused infinite recursion
- **Solution**: Simplified policies that avoid circular references
- **Impact**: Improved performance and stability

### **Category Relationship**

- **Current**: Using `category_id` field
- **Future**: Migrating to `category` FK for better normalization
- **Migration**: Automatic via database fixes script

### **Bag Fee Management**

- **Current**: Hardcoded 50 pence
- **Future**: Configurable via `configurable_fees` table
- **Benefit**: Easy price updates without code changes

## üìö **Related Documentation**

- [Database Deployment Guide](../DEPLOYMENT_GUIDE.md)
- [Database Fixes Script](../database_fixes.sql)
- [Frontend Implementation](../frontend-implementation.md)

---

**Last Updated:** August 13, 2025  
**Version:** 2.0.0  
**Author:** TJ's Bake & Browse Development Team
