# 📊 TJ's Bake & Browse - Data Models & API Reference

## 🗄️ **Database Schema**

### **Products Table**

```sql
CREATE TABLE public.products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    sku TEXT UNIQUE NOT NULL,
    short_description TEXT,
    full_description TEXT,
    price_pence INTEGER NOT NULL CHECK (price_pence >= 0),
    pack_label TEXT,
    allergens TEXT[] DEFAULT '{}',
    ingredients TEXT,
    nutritional_info JSONB,
    image_url TEXT,
    stock_quantity INTEGER NOT NULL DEFAULT 0,
    low_stock_threshold INTEGER DEFAULT 5,
    is_visible BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    category_id UUID REFERENCES public.categories(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Key Fields:**

- `price_pence`: Price stored in pence (e.g., 450 = £4.50)
- `allergens`: Array of allergen codes (e.g., ['milk', 'eggs', 'tree_nuts'])
- `is_visible`: Controls whether product appears in customer catalogue
- `stock_quantity`: Current inventory level

### **Categories Table**

```sql
CREATE TABLE public.categories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    slug TEXT UNIQUE NOT NULL,
    description TEXT,
    image_url TEXT,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Predefined Categories:**

- `baked_goods`: Freshly baked goods and treats
- `groceries`: Pantry essentials and ingredients
- `specialty_items`: Unique and seasonal items
- `beverages`: Hot and cold drinks

### **Orders Table**

```sql
CREATE TABLE public.orders (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    order_number BIGINT GENERATED BY DEFAULT AS IDENTITY UNIQUE,
    user_id UUID REFERENCES public.users(id) ON DELETE SET NULL,
    status TEXT NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'confirmed', 'preparing', 'ready', 'collected', 'cancelled')),
    pickup_date DATE NOT NULL,
    pickup_time TIME NOT NULL,
    subtotal_pence INTEGER NOT NULL,
    tax_pence INTEGER NOT NULL DEFAULT 0,
    bag_fee_pence INTEGER NOT NULL DEFAULT 0,
    total_pence INTEGER NOT NULL,
    customer_name TEXT NOT NULL,
    customer_email TEXT NOT NULL,
    customer_phone TEXT,
    special_instructions TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Status Flow:**

1. `pending` - Order created, awaiting confirmation
2. `confirmed` - Order confirmed, payment received
3. `preparing` - Items being prepared
4. `ready` - Order ready for pickup
5. `collected` - Order collected by customer
6. `cancelled` - Order cancelled

### **Order Items Table**

```sql
CREATE TABLE public.order_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    order_id UUID REFERENCES public.orders(id) ON DELETE CASCADE,
    product_id UUID REFERENCES public.products(id),
    product_name TEXT NOT NULL,
    product_sku TEXT NOT NULL,
    quantity INTEGER NOT NULL,
    unit_price_pence INTEGER NOT NULL,
    total_price_pence INTEGER NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **Configurable Fees Table**

```sql
CREATE TABLE public.configurable_fees (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    fee_type TEXT NOT NULL DEFAULT 'fixed'
        CHECK (fee_type IN ('fixed', 'percentage')),
    amount_pence INTEGER NOT NULL DEFAULT 0,
    percentage_rate DECIMAL(5,2) DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    applies_to TEXT[] DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Current Fees:**

- Bag Fee: £0.50 (optional)

## 🔌 **API Endpoints**

### **Products API**

#### `GET /api/products`

Returns all visible products with category information.

**Response:**

```json
{
	"products": [
		{
			"id": "uuid",
			"name": "Gluten-Free Sourdough Bread",
			"price_pence": 450,
			"image_url": "/images/products/sourdough.jpg",
			"pack_label": "500g",
			"allergens": ["none"],
			"sku": "GF-SOUR-001",
			"stock": 15,
			"visible": true,
			"category_id": "uuid",
			"categories": {
				"id": "uuid",
				"name": "Baked Goods",
				"slug": "baked_goods"
			}
		}
	]
}
```

**Note:** Currently returns all products with `is_visible = true` regardless of stock level pending product visibility policy decision.

### **Orders API**

#### `POST /api/orders`

Creates a new customer order.

**Request:**

```json
{
	"pickup_date": "2025-08-15",
	"pickup_time": "10:00-12:00",
	"customer_name": "John Doe",
	"customer_email": "john@example.com",
	"bag_opt_in": true,
	"items": [
		{
			"product_id": "uuid",
			"quantity": 2,
			"price_pence": 450
		}
	]
}
```

**Response:**

```json
{
	"success": true,
	"order": {
		"id": "uuid",
		"order_number": 1001,
		"status": "pending",
		"total_pence": 950
	}
}
```

### **Admin APIs**

#### `GET /api/admin/orders`

Returns all orders for admin management.

#### `PATCH /api/admin/orders/[id]`

Updates order status.

**Request:**

```json
{
	"status": "confirmed"
}
```

#### `GET /api/admin/inventory`

Returns products for inventory management.

#### `PATCH /api/admin/inventory/[id]`

Updates product inventory or visibility.

### **Time Slots API**

#### `GET /api/slots`

Returns available pickup time slots.

**Parameters:**

- `date`: Date to check availability (YYYY-MM-DD)

**Response:**

```json
{
	"slots": [
		{
			"time": "09:00",
			"available": true,
			"capacity": 5,
			"booked": 2
		}
	]
}
```

## 🔒 **Security & Access Control**

### **Row Level Security (RLS)**

- **Products/Categories**: Public read access
- **Orders**: Users can only access their own orders
- **Order Items**: Linked to order access policies
- **Admin APIs**: Require admin authentication

### **Authentication**

- **NextAuth.js**: Session-based authentication
- **Admin Access**: Controlled by email whitelist or user role
- **Guest Orders**: Supported for customer convenience

## 💾 **Data Storage**

### **Client-Side Storage**

- **Shopping Cart**: localStorage with cross-tab sync
- **User Preferences**: localStorage
- **Session Data**: NextAuth.js cookies

### **File Storage**

- **Product Images**: Public folder (`/public/images/products/`)
- **Category Images**: Public folder (`/public/images/categories/`)
- **Static Assets**: Public folder

## 🎯 **Business Rules**

### **Operating Hours**

- **Days**: Monday-Saturday
- **Hours**: 09:00-17:30
- **Slot Duration**: 30 minutes
- **Capacity**: 5 orders per slot (configurable)

### **Pricing**

- All prices stored in pence (whole numbers)
- Bag fee configurable via `configurable_fees` table
- No VAT currently applied (set to 0)

### **Stock Management**

- Stock decremented on order creation
- Low stock alerts at configurable thresholds
- Out-of-stock policy pending decision

## 📈 **Performance Considerations**

### **Database Indexes**

```sql
CREATE INDEX idx_products_category_id ON public.products(category_id);
CREATE INDEX idx_products_is_visible ON public.products(is_visible);
CREATE INDEX idx_products_stock_quantity ON public.products(stock_quantity);
CREATE INDEX idx_orders_status ON public.orders(status);
CREATE INDEX idx_orders_pickup_date ON public.orders(pickup_date);
CREATE INDEX idx_order_items_order_id ON public.order_items(order_id);
```

### **Caching Strategy**

- Consider Redis for frequently accessed product data
- API response caching for product catalogue
- Static asset caching via CDN

---

**Last Updated:** Current Date  
**Schema Version:** 2.0.0  
**Next Review:** When major changes planned
